# 1. cloudcone

yumecoder.top

## DNS 解析迁移

## 定时任务

```sh
MAILTO=1017086648@qq.com
0 3 1,15 \* \* perl -e 'sleep int(rand(3600))' && /home/yuusha/docker-cmd/certbot/yumecoder.top/renew.sh > /dev/null && sudo systemctl reload nginx
```

相关脚本在 `~/docker-cmd/certbot/yumecoder.top` 中，签发证书的域名为 `yumecoder.top,*.yumecoder.top`

## [完成] nginx 配置文件

均在 `conf.d/` 目录下。

### yumecoder 相关的配置

`m.yumecoder.top.conf`:

```conf
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name m.yumecoder.top;

  ssl_certificate /etc/letsencrypt/live/yumecoder.top/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/yumecoder.top/privkey.pem;
  ssl_trusted_certificate /etc/letsencrypt/live/yumecoder.top/chain.pem;

  include snippets/ssl.conf;

  location / {
    proxy_pass http://localhost:6002;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
```

`sit.yumecoder.top.conf`:

```conf
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name sit.yumecoder.top;

  ssl_certificate /etc/letsencrypt/live/yumecoder.top/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/yumecoder.top/privkey.pem;
  ssl_trusted_certificate /etc/letsencrypt/live/yumecoder.top/chain.pem;

  include snippets/ssl.conf;

  location / {
    proxy_pass http://localhost:6001;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
```

考虑改为 `sit-m.yumecoder.top`。

`api.yumecoder.top.conf`:

```sh
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name api.yumecoder.top;

  ssl_certificate /etc/letsencrypt/live/yumecoder.top/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/yumecoder.top/privkey.pem;
  ssl_trusted_certificate /etc/letsencrypt/live/yumecoder.top/chain.pem;

  include snippets/ssl.conf;

  location ^~ /sit/ {
    proxy_pass http://localhost:7001/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location ^~ /prod/ {
    proxy_pass http://localhost:7002/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
```

### [完成] gitbook 相关

`gitbook.yumecoder.top.conf`:

```conf
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name gitbook.yumecoder.top;

  ssl_certificate /etc/letsencrypt/live/yumecoder.top/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/yumecoder.top/privkey.pem;
  ssl_trusted_certificate /etc/letsencrypt/live/yumecoder.top/chain.pem;

  include snippets/ssl.conf;

  location / {
    proxy_pass http://localhost:3001;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
```

docker 容器启动脚本在 `~/docker-cmd/gitbook//gitbook_server-startup.sh` ：

```sh
#!/bin/bash

# gitbook仓库路径【必须为绝对路径】
GITBOOK_REPO="/home/yuusha/gitbook-repo"

# 宿主机暴露的端口
HOST_EXPOSE_PORT=3001

# docker容器名称
CONTAINER_NAME="gitbook_server"

# nginx配置文件路径
NGINX_CONF_PATH="/home/yuusha/configs/gitbook/gitbook_nginx.conf"

sudo docker run -d \
  --restart unless-stopped \
  --name $CONTAINER_NAME \
  -p $HOST_EXPOSE_PORT:80 \
  -v $GITBOOK_REPO:/usr/share/nginx/html \
  -v $NGINX_CONF_PATH:/etc/nginx/nginx.conf \
  nginx
```

数据存储目录在 `~/gitbook-repo`。

## [完成] mysql

`~/docker-cmd/mysql-startup.sh`：

```sh
#!/bin/bash

# docker run --name <container-name> -e MYSQL_ROOT_PASSWORD=<mysql-passwd> -d mysql:<mysql-image-tag>
# 还需要加上端口号 -p 3306:3306
# 以及重启策略 --restart=unless-stopped (或者 always)

sudo docker run --name mysql -e MYSQL_ROOT_PASSWORD=mysqlPWD#1026 -p 3306:3306 --restart=unless-stopped -d mysql:5.7.30
```

数据库已经导出到 `~/all-dbs.sql` 文件中了。

改为将密码保存在 `.env` 中。

添加 宿主机目录 `data` 挂载。

字符集确认一下为 `utf8mb4`。

## [完成] tomcat 原版 yumecoder 项目

复制 `~/tomcat_webapps` ，改名为 `yumecoder_java`，其中包含的是 war 包。

docker 启动文件在 `~/docker-cmd/tomcat_webapps` 中。涉及这几个仓库，需要修改 `github actions` 中的配置信息：

```sh
above-coding  daily-notes  gitbook-usage  ITCAST-WEB-39-NOTE  高考语文试题
```

```yaml
services:
  web:
    image: tomcat:8-jdk8-corretto
    container_name: yumecoder_web_tomcat
    restart: unless-stopped
    ports:
      - 8081:8080
    volumes:
      - ./yumecoder_tomcat/web:/usr/local/tomcat/webapps
  admin:
    image: tomcat:8-jdk8-corretto
    container_name: yumecoder_admin_tomcat
    restart: unless-stopped
    ports:
      - 8082:8080
    volumes:
      - ./yumecoder_tomcat/admin:/usr/local/tomcat/webapps
```

## [完成] yumecoder

`yumecoder_portal` nginx 配置文件中：

```conf
location / {
    root   /usr/share/nginx/html;
    index  index.html index.htm;

    # 访问不存在的路径重定向到 index.html
    try_files  $uri $uri/ /index.html;
}


# 禁止访问 sourcemap 文件
location ~* \.map$ {
        deny all;
        access_log off;
        log_not_found off;
    }
```

## [完成] 涉及的 DNS

```sh
[可移除]
A
cloudcone
134.195.209.17
DNS only

A
gitbook
134.195.209.17
DNS only


A
mysql
134.195.209.17
DNS only

[可移除]
A
outernet
134.195.209.17
DNS only


[改指向]
A
www
134.195.209.17
DNS only
A
*
134.195.209.17
DNS only
A
yumecoder.top
134.195.209.17
DNS only
```

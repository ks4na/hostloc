# 快速初始化服务器

快速初始化服务器，用于迁移到其他机器。

## 背景

目前应用可以都通过 docker 来部署，应用迁移很简单，服务器上有安装 docker 即可；
但是如果新买一个 VPS，那么安装 docker 等等一系列步骤还是需要手动来操作，且步骤比较繁琐。

所以现在考虑将服务器初始化这个过程自动化。

## 需要初始化配置的项

1. 修改 root 密码，生成 ed25519 密钥，并设置仅允许密钥方式登录【这一步手动操作，不纳入自动化】
2. 更新 apt，安装 curl，git ，vim 等基础软件
3. 安装 docker、docker-compose 等
4. 安装防火墙 firewalld
5. 时区设置，NTP 时间同步
6. https 证书的自动生成和更新
7. (TODO) 接入监控系统

## 方案

### 1. 自定义镜像

从本地 PVE 中的虚拟机导出 `.qcow2` 等格式的镜像。

优势：

- 最简单

缺点：

- 不支持条件化定制安装
- 需要 VPS 商家支持
- 只针对虚拟机，物理机则不适用

### 2. 自动化脚本

自己写自动化脚本 `install_script.sh`。

优势：

- 灵活

缺点：

- 需要详尽的测试脚本能否正常工作
- 条件化定制安装不太容易实现
- 不太方便维护

### 3. ansible、cloudinit

优势：

- 可高度条件化定制
- 配置文件编写，更方便维护
- 能够多机同时部署

缺点：

- 有学习成本

## 基础环境配置内容

### 修改 root 密码，生成密钥，设置仅允许密钥方式登录

参见 `learn-linux` 相关笔记。

### 安装基础软件

确认 sudo、curl、git、vim 等基础软件已经安装了：

```sh
apt update
apt install sudo curl git vim rsync -y
```

### 阻止 ssh 暴力登录攻击

设置为仅允许密钥方式登录。参见 `learn-linux` 相关笔记。

### 设置防火墙

安装 `firewalld` 或者 `ufw` ，详见 `learn-linux` 笔记。

> 注意：docker 容器暴露端口的写法必须指定为类似 `127.0.0.1:80:80` 这种仅 `127.0.0.1` 本机可访问的方式，否则会将端口暴露给外网。

### 安装 docker 和 docker-compose

> 参照 [docker 官网文档](https://docs.docker.com/engine/install/debian/#install-using-the-repository)

> 无法科学上网时，可以将以下命令中的 `https://download.docker.com/linux/debian` 替换为清华源 `https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/debian`。

设置 docker 的 apt 仓库：

```sh
# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl gnupg -y
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
```

安装 docker：

```sh
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y
```

验证 docker 和 docker-compose 安装成功：

```sh
docker run hello-world

docker compose version
```

### 时区、NTP 时间同步设置

```sh
# 设置时区
timedatectl set-timezone Asia/Shanghai

# NTP 时间同步应该默认开启了
# timedatectl
      Local time: Tue 2024-05-28 16:53:39 CST
  Universal time: Tue 2024-05-28 08:53:39 UTC
        RTC time: Tue 2024-05-28 08:53:39
       Time zone: Asia/Shanghai (CST, +0800)
     NTP enabled: yes
NTP synchronized: yes
 RTC in local TZ: no
      DST active: n/a
```

### 创建 nginx 反向代理网关

参看 `learn-linux` 中相关笔记。

### https 证书申请

参看 `learn-linux` 中相关笔记。

### (TODO) 接入监控系统

- uptime kuma
- prometheus + grafana
